"use strict";var Go=Object.create;var de=Object.defineProperty;var Wo=Object.getOwnPropertyDescriptor;var Ho=Object.getOwnPropertyNames;var Bo=Object.getPrototypeOf,jo=Object.prototype.hasOwnProperty;var C=(s,e)=>()=>(s&&(e=s(s=0)),e);var ot=(s,e)=>{for(var t in e)de(s,t,{get:e[t],enumerable:!0})},st=(s,e,t,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of Ho(e))!jo.call(s,r)&&r!==t&&de(s,r,{get:()=>e[r],enumerable:!(o=Wo(e,r))||o.enumerable});return s};var h=(s,e,t)=>(t=s!=null?Go(Bo(s)):{},st(e||!s||!s.__esModule?de(t,"default",{value:s,enumerable:!0}):t,s)),zo=s=>st(de({},"__esModule",{value:!0}),s);var le=C(()=>{"use strict"});function k(){return rt.workspace.getConfiguration("chatgpt")}var rt,nt,it,z=C(()=>{"use strict";rt=h(require("vscode")),nt="apiEndpoint",it="logLevel"});function ue(s){return at[s]<=at[Jo]}function Xo(){let s=ct.window.createOutputChannel("Codex",{log:!0});return{trace:(t,...o)=>{ue("trace")&&s.trace(t,...o)},debug:(t,...o)=>{ue("debug")&&s.debug(t,...o)},info:(t,...o)=>{ue("info")&&s.info(t,...o)},error:(t,...o)=>{s.error(t,...o)},warn:(t,...o)=>{ue("warning")&&s.warn(t,...o)},dispose:()=>s.dispose()}}var ct,Ko,Jo,at,p,S=C(()=>{"use strict";z();le();ct=h(require("vscode")),Ko="warning",Jo=k().get(it)??Ko,at={error:0,warning:1,info:2,debug:3,trace:4};p=Xo()});function Vt(s){return Object.prototype.hasOwnProperty.call(Ne,s)?s:null}var $t,Q,Ne,qt,Gt,Wt,ne,Ht,Bt,jt,zt,Kt,W=C(()=>{"use strict";$t=require("crypto"),Q=h(require("vscode")),Ne={content:{category:"queryGet",version:1},ping:{category:"queryGet",version:1},selections:{category:"queryGet",version:1},reload:{category:"queryGet",version:1},markForReload:{category:"queryPost",version:1},removeHighlights:{category:"mutationPost",version:1},highlightLines:{category:"mutationPost",version:1},highlight:{category:"mutationPost",version:1},setContent:{category:"mutationPost",version:1},replaceSelection:{category:"mutationPost",version:1}},qt=Object.fromEntries(Object.entries(Ne).map(([s,e])=>[s,e.version]));Gt=`oai_pwai ${Q.env.appName}`,Wt=Q.workspace.name??Q.env.appName,ne=Q.env.appName+"-"+(0,$t.randomUUID)(),Ht="com.microsoft.VSCode",Bt="com.microsoft.VSCodeInsiders",jt="com.vscodium",zt="com.todesktop.230313mzl4w4u92",Kt="com.exafunction.windsurf"});function L(s){return Je().find(o=>o.document.fileName===s)||null}function Xt(){return Je().map((e,t)=>{let o=e.selection.isEmpty?null:e.document.getText(e.selection),r=e.selection.isEmpty?null:e.selection.start.line;return o!=null&&r!=null?{selectedText:o,selectionLine:r}:null}).filter(e=>!!e)}function Qt(){return Je().map((e,t)=>{let o=e.document.getText(),r=e.document.fileName,n=e.selection.isEmpty?null:e.document.getText(e.selection),i=e.document.offsetAt(e.selection.start),a=e.document.offsetAt(e.selection.end),c=e.selection.isEmpty?null:e.selection.start.line,d=e.selection.isEmpty?null:{location:i,length:a-i};return n===o&&(n=null),{id:r,content:o,filename:r,selectedText:n,selectionRange:d,selectionLine:c}}).filter(e=>!!e)}function Je(){return Jt.window.visibleTextEditors.filter(e=>e.viewColumn!==void 0)}var Jt,De=C(()=>{"use strict";Jt=h(require("vscode"))});function F(s){throw new Error(`No editor for id ${s} found`)}var Xe=C(()=>{"use strict"});async function Yt(s,e){let t=L(e);t||F(e);let o=t.document,r=new Y.Range(o.positionAt(0),o.positionAt(o.getText().length));await t.edit(i=>{i.replace(r,s)});let n=t.document.positionAt(s.length);t.selection=new Y.Selection(n,n)}async function Zt(s,e){let t=L(e);t||F(e);let o=t.selection,r=new Y.Range(o.start,o.end);await t.edit(n=>{n.replace(r,s)}),t.selection=new Y.Selection(r.start,r.start)}var Y,eo=C(()=>{"use strict";De();Xe();Y=h(require("vscode"))});async function oo(s,e){let t=L(e);t||F(e);let o=s.map(r=>{let n=new I.Range(r,0,r,t.document.lineAt(r).range.end.character);return so(n,e)});await Promise.all(o)}function As(s){return new Promise(e=>setTimeout(e,s))}async function so(s,e){let t=L(e);t||F(e),t.revealRange(s,I.TextEditorRevealType.InCenterIfOutsideViewport);let o=I.window.createTextEditorDecorationType({backgroundColor:`rgba(255, 255, 0, ${to})`,isWholeLine:!0});t.setDecorations(o,[s]);let r=I.workspace.onDidChangeTextDocument(n=>{n.document===t.document&&(o.dispose(),H[e]=[],r.dispose())});H[e]||(H[e]=[]),H[e].push({range:s,decoration:o})}async function ro(s,e){let t=L(s);t||F(s),ie[s]||(ie[s]=1);let o=++ie[s];if(e){let i=(H[s]||[]).map(async a=>{let c=a.decoration,d=10,f=500/d;try{for(let l=0;l<=d&&o===ie[s];l++){let g=l/d,y=to*(1-g),P=I.window.createTextEditorDecorationType({backgroundColor:`rgba(255, 255, 0, ${y})`,isWholeLine:!0});t.setDecorations(P,[a.range]),c?.dispose(),c=P,await As(f)}}finally{c?.dispose()}});await Promise.all(i)}let r=H[s];r&&o===ie[s]&&(r.forEach(n=>n.decoration.dispose()),delete H[s])}async function no(s,e,t){let o=L(t);o||F(t);let r=Ms(s,e,o.document);r&&await so(r,t)}function Ms(s,e,t){let o=0,r=0,n=0,i=0,a=0;for(let c=0;c<t.lineCount;c++){let u=t.lineAt(c).text.length+1;if(o<=s&&o+u>s&&(r=c,i=s-o),o<=e&&o+u>e){n=c,a=e-o;break}o+=u}if(r>=0&&n>=0){let c=new I.Position(r,i),d=new I.Position(n,a);return new I.Range(c,d)}return null}var I,H,ie,to,io=C(()=>{"use strict";De();Xe();I=h(require("vscode")),H={},ie={},to=.2});async function po(s,e){switch(s){case"removeHighlights":try{let{textfieldID:t,animated:o}=e;return await ro(t,o),{status:"success",message:"Removed highlight"}}catch(t){return{status:400,error:JSON.stringify(t)}}case"highlightLines":try{let{lines:t,textfieldID:o}=e;return await oo(t,o),{status:"success",message:"Text highlighted successfully"}}catch(t){return{status:400,error:JSON.stringify(t)}}case"highlight":try{let{startChar:t,endChar:o,textfieldID:r}=e;return await no(t,o,r),{status:"success",message:"Text highlighted successfully"}}catch(t){return{status:400,error:JSON.stringify(t)}}case"setContent":try{let{content:t,textfieldID:o}=e;return await Yt(t,o),{status:"success",message:"Set content successfully"}}catch(t){return{status:400,error:JSON.stringify(t)}}case"replaceSelection":try{let{content:t,textfieldID:o}=e;return await Zt(t,o),{status:"success",message:"Replaced selection successfully"}}catch(t){return{status:400,error:JSON.stringify(t)}}}}var lo=C(()=>{"use strict";W();eo();io()});async function uo(s,e){let t=Buffer.alloc(0),o=null;s.on("data",async r=>{if(t=Buffer.concat([t,r]),o==null&&t.length>=4&&(o=t.readUInt32LE(0),t=t.subarray(4)),o!=null&&t.length>=o){let n=t.subarray(0,o).toString();t=t.subarray(o),o=null,await e(s,n)}}),s.on("end",()=>{p.debug("Desktop bridge: client disconnected")}),s.on("error",r=>{p.error("Desktop bridge socket error:",r)})}function ae(s,e){let t=JSON.stringify(e),o=Buffer.alloc(4),r=Buffer.byteLength(t);o.writeUInt32LE(r,0);let n=Buffer.from(t,"utf-8");s.write(o),s.write(n),s.end()}var Qe=C(()=>{"use strict";S()});function Ye(){return _e.join(fo.homedir(),"Library","Application Support","com.openai.chat","app_pairing_extensions",ne)}function Ds(s){let e=Ye();if(x.existsSync(e)){let t=x.watch(e,o=>{x.existsSync(e)||(s(),t.close())})}else p.warn("Desktop bridge: session path does not exist, cannot watch file.")}var x,mo,fo,_e,Oe,ho=C(()=>{"use strict";S();W();Qe();x=h(require("fs")),mo=h(require("net")),fo=h(require("os")),_e=h(require("path"));Oe=class{getSessionSocketPath(){return`/tmp/${ne}.sock`}async deregister(){let e=Ye();p.info("Desktop bridge deregister",e),x.existsSync(e)&&x.unlinkSync(e),x.existsSync(this.getSessionSocketPath())&&x.unlinkSync(this.getSessionSocketPath())}async register(e,t){let o=Ye(),r=_e.dirname(o);x.existsSync(r)||x.mkdirSync(r,{recursive:!0}),x.writeFileSync(o,JSON.stringify(e),"utf8"),p.info(`Desktop bridge wrote payload to ${o}`);let n=this.getSessionSocketPath();x.existsSync(n)?x.chmodSync(n,384):p.warn("Desktop bridge: socket file does not exist"),Ds(t)}startServer(e,t){let o=this.getSessionSocketPath();x.existsSync(o)&&x.unlinkSync(o);let r=mo.createServer(n=>{p.debug("Desktop bridge: client connected"),uo(n,t)});r.listen(o,()=>{p.info(`Desktop bridge listening on UNIX socket: ${o}`)}),e.subscriptions.push({dispose:()=>{r.close(),this.deregister()}})}}});function Os(){if(go.platform()!=="darwin")throw new Error("Unsupported platform");return new Oe}var go,B,Ze=C(()=>{"use strict";ho();go=h(require("os"));B=Os()});function vo(){switch(yo.env.appName){case"Visual Studio Code":return Ht;case"Visual Studio Code - Insiders":return Bt;case"VSCodium":return jt;case"Cursor":return zt;case"Windsurf":return Kt;default:return null}}var yo,wo=C(()=>{"use strict";W();yo=h(require("vscode"))});var _s,ce,et=C(()=>{"use strict";_s="0.0.1731016154",ce={name:"openai.chatgpt",version:_s,isInstalled:!0}});function xo(s){bo=s,B.deregister(),Le()}function Le(){let s=vo();if(!s)return;let e=B.getSessionSocketPath(),t={appName:U.env.appName,bundleID:s,extensionVersion:ce.version,marketplaceID:ce.name,extensionName:Gt,workspaceName:Wt,id:ne,capabilities:qt,needsReload:bo,socketPath:e,timestamp:Date.now()};B.register(t,()=>{let o=U.l10n.t("Reregister"),r=U.l10n.t("Dismiss");U.window.showWarningMessage(U.l10n.t("The ChatGPT extension cannot find its registration file"),o,r).then(n=>{n===o&&Le()})})}var U,bo,tt=C(()=>{"use strict";wo();W();Ze();et();U=h(require("vscode")),bo=!1});function Co(s){switch(s){case"ping":{let{name:e,version:t}=ce;return{status:"success",version:t,name:e}}case"content":{let e=Qt();return e!=null?{status:"success",textfields:e}:{status:400,error:"No active editor found"}}case"selections":{let e=Xt();return e!=null?{status:"success",selections:e}:{status:400,error:"No active editor found"}}case"reload":return Ro.commands.executeCommand("workbench.action.reloadWindow"),{status:"success"}}}async function So(s){switch(s){case"markForReload":return xo(!0),{status:"success",message:"Marked for reload"}}}var Ro,Po=C(()=>{"use strict";W();De();tt();et();Ro=h(require("vscode"))});var Io={};ot(Io,{activate:()=>Fs,deactivate:()=>Us,respondToCompleteMessage:()=>To});function Fs(s){Ls==="darwin"&&(p.info("ChatGPT desktop bridge active"),B.startServer(s,To),Le(),p.info("Desktop bridge registered"))}function Us(){B.deregister()}async function To(s,e){try{let t=JSON.parse(e),o=Vt(t.command);if(!o){ae(s,{status:404,error:"Unknown endpoint"});return}if(!ko.workspace.isTrusted&&o!=="ping"){p.warn("Desktop bridge: untrusted workspace"),ae(s,{status:405,error:"The workspace must be trusted for the extension to read content."});return}let r=await $s(o,t.payload);r.status===400&&p.error("Desktop bridge error for command:",t.command),ae(s,r)}catch(t){p.error("Desktop bridge: error processing message:",t),ae(s,{success:!1,error:"Error handling message"})}}async function $s(s,e){let{category:t}=Ne[s];switch(t){case"queryGet":return Co(s);case"queryPost":return So(s);case"mutationPost":return po(s,e)}}var Eo,ko,Ls,Ao=C(()=>{"use strict";W();lo();Ze();Po();tt();Qe();S();Eo=h(require("os")),ko=h(require("vscode")),Ls=Eo.platform()});var Vs={};ot(Vs,{activate:()=>qs});module.exports=zo(Vs);le();S();var me=require("fs"),dt=h(require("os")),Ue=h(require("path")),w=h(require("vscode")),Qo=5173,Yo=`http://localhost:${Qo}`,Zo="/src/main.tsx",q=class s{constructor(e,t,o,r){this.extensionUri=e;this.codexMcpConnection=t;this.fetchWrapper=o;this.ideContextConnection=r;this.subscriptions.push(w.commands.registerCommand("chatgpt.implementTodo",async({line:n,fileName:i,comment:a})=>{await N();let c={fileName:i,line:n,comment:a};this.sidebarView&&this.webviewReady?this.postMessageToView(this.sidebarView.webview,{type:"implement-todo",...c}):this.pendingImplementTodo=c})),this.subscriptions.push(w.workspace.onDidChangeWorkspaceFolders(()=>{this.sidebarView&&this.postMessageToView(this.sidebarView.webview,{type:"workspace-roots-updated"}),this.editorPanel&&this.postMessageToView(this.editorPanel.webview,{type:"workspace-roots-updated"})}))}static viewType="chatgpt.sidebarView";static providerName="webview";sidebarView;editorPanel;subscriptions=[];mcpProviderDisposable;webviewReady=!1;pendingImplementTodo=null;pendingContextFiles=[];pendingNavigationRoutes=[];async resolveWebviewView(e,t,o){this.sidebarView=e;let{webview:r}=e,n=w.Uri.joinPath(this.extensionUri,"webview");r.options={enableScripts:!0,enableCommandUris:!1,localResourceRoots:[n]},r.onDidReceiveMessage(i=>{if(i.type==="ready"){if(this.webviewReady=!0,this.pendingImplementTodo&&(this.postMessageToView(r,{type:"implement-todo",...this.pendingImplementTodo}),this.pendingImplementTodo=null),this.pendingContextFiles.length>0){for(let a of this.pendingContextFiles)this.postMessageToView(r,{type:"add-context-file",file:a});this.pendingContextFiles=[]}if(this.pendingNavigationRoutes.length>0){for(let{path:a,state:c}of this.pendingNavigationRoutes)this.postMessageToView(r,{type:"navigate-to-route",path:a,state:c});this.pendingNavigationRoutes=[]}}this.handleMessage(r,i)}),this.mcpProviderDisposable?.dispose(),this.mcpProviderDisposable=this.codexMcpConnection.registerProvider(s.providerName,{onResult:i=>{this.postMessageToView(r,{type:"mcp-response",message:i}),this.editorPanel&&this.postMessageToView(this.editorPanel.webview,{type:"mcp-response",message:i})},onRequest:i=>{this.postMessageToView(r,{type:"mcp-request",request:i}),this.editorPanel&&this.postMessageToView(this.editorPanel.webview,{type:"mcp-request",request:i})},onNotification:i=>{let{method:a,params:c}=i;this.postMessageToView(r,{type:"mcp-notification",method:a,params:c}),this.editorPanel&&this.postMessageToView(this.editorPanel.webview,{type:"mcp-notification",method:a,params:c})}}),this.subscriptions.push(this.ideContextConnection.onIdeContextChange(()=>{this.postMessageToView(r,{type:"ide-context-updated"})})),r.html=await this.getWebviewContent(r),this.subscriptions.push(e.onDidDispose(()=>{this.sidebarView=void 0,this.webviewReady=!1,this.mcpProviderDisposable?.dispose(),this.mcpProviderDisposable=void 0})),this.subscriptions.push(e.onDidChangeVisibility(()=>{w.commands.executeCommand("setContext","chatgpt.sidebarView.visible",e.visible)}))}triggerNewChatViaWebview(){this.sidebarView&&this.webviewReady&&this.postMessageToView(this.sidebarView.webview,{type:"new-chat"})}postMessageToView(e,t){let o=JSON.stringify(t);e.postMessage(o)}addContextFile(e){let t={type:"add-context-file",file:e};this.sidebarView&&this.webviewReady?this.postMessageToView(this.sidebarView.webview,t):this.pendingContextFiles.push(e)}navigateToRoute(e,t){let o={type:"navigate-to-route",path:e,state:t};this.sidebarView&&this.webviewReady?this.postMessageToView(this.sidebarView.webview,o):this.pendingNavigationRoutes.push({path:e,state:t})}async handleMessage(e,t){switch(t.type){case"ready":break;case"mcp-request":{let{id:o,method:r,params:n}=t.request;this.codexMcpConnection.sendRequest(s.providerName,String(o),r,n);break}case"mcp-notification":{let{method:o,params:r}=t.request;this.codexMcpConnection.sendNotification(o,r);break}case"mcp-response":{let{id:o,result:r}=t.response;this.codexMcpConnection.sendResponse(o,r);break}case"open-in-browser":{w.env.openExternal(w.Uri.parse(t.url));break}case"open-extension-settings":{w.commands.executeCommand("workbench.action.openSettings","@ext:openai.chatgpt");break}case"open-keyboard-shortcuts":{w.commands.executeCommand("workbench.action.openGlobalKeybindings","chatgpt");break}case"open-config-toml":{let o=Ue.join(dt.homedir(),".codex"),r=Ue.join(o,"config.toml");await me.promises.mkdir(o,{recursive:!0});try{await me.promises.access(r)}catch(n){let i=n;if("code"in i&&i.code==="ENOENT")await me.promises.writeFile(r,"");else throw n}await w.commands.executeCommand("vscode.open",w.Uri.file(r));break}case"show-diff":{this.showDiff({unifiedDiff:t.unifiedDiff});break}case"update-diff-if-open":{this.editorPanel&&this.postMessageToView(this.editorPanel.webview,{type:"navigate-to-route",path:"/diff",state:{unifiedDiff:t.unifiedDiff}});break}case"fetch":{let o=await this.fetchWrapper.fetch(t);this.postMessageToView(e,o);break}case"cancel-fetch":{this.fetchWrapper.cancel(t.requestId);break}case"fetch-stream":{this.fetchWrapper.stream(t,o=>this.postMessageToView(e,o));break}case"cancel-fetch-stream":{this.fetchWrapper.cancelStream(t.requestId);break}case"log-message":{let{level:o,message:r}=t;switch(o){case"trace":p.trace(r);break;case"debug":p.debug(r);break;case"info":p.info(r);break;case"warning":p.warn(r);break;case"error":p.error(r);break}break}}}async getWebviewContent(e){return this.getWebviewContentProduction(e)}async getWebviewContentProduction(e){let t=w.Uri.joinPath(this.extensionUri,"webview"),o=w.Uri.joinPath(t,"index.html"),r=await w.workspace.fs.readFile(o),n=new TextDecoder("utf-8").decode(r),i=e.asWebviewUri(t).toString()+"/",a=pt(i),c=["default-src 'none'",`img-src ${e.cspSource} https: data: blob:`,`script-src ${e.cspSource}`,`style-src ${e.cspSource} 'unsafe-inline'`,`font-src ${e.cspSource}`,`connect-src ${e.cspSource}`].join("; ")+";",d=pt(c);return n.replace("<!-- PROD_BASE_TAG_HERE -->",`<base href="${a}">`).replace("<!-- PROD_CSP_TAG_HERE -->",`<meta http-equiv="Content-Security-Policy" content="${d}">`)}getWebviewContentDevelopment(){return`<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="${w.Uri.parse(Yo).toString()}">

    <!-- Hot reloading code from Vite -->
    <script type="module">
        import RefreshRuntime from "/@react-refresh"
        RefreshRuntime.injectIntoGlobalHook(window)
        window.$RefreshReg$ = () => {}
        window.$RefreshSig$ = () => (type) => type
        window.__vite_plugin_react_preamble_installed__ = true
    </script>
    <script type="module" src="/@vite/client"></script>
    <script type="module" src="${Zo}"></script>
    <script src="http://localhost:8097"></script>
</head>
<body tabindex="0" style="outline: none">
    <div id="root"></div>
</body>
</html>`}dispose(){this.subscriptions.forEach(e=>e.dispose())}async showDiff(e){if(this.editorPanel)this.editorPanel.reveal(w.ViewColumn.One),this.postMessageToView(this.editorPanel.webview,{type:"navigate-to-route",path:"/diff",state:{unifiedDiff:e.unifiedDiff}});else{let t=w.Uri.joinPath(this.extensionUri,"webview");this.editorPanel=w.window.createWebviewPanel("codexEditorView","Codex",w.ViewColumn.One,{enableScripts:!0,retainContextWhenHidden:!0,localResourceRoots:[t]}),this.subscriptions.push(this.editorPanel.onDidDispose(()=>{this.editorPanel=void 0}));let{webview:o}=this.editorPanel;o.html=await this.getWebviewContent(o),this.subscriptions.push(o.onDidReceiveMessage(async r=>{r.type==="ready"&&this.postMessageToView(o,{type:"navigate-to-route",path:"/diff",state:{unifiedDiff:e.unifiedDiff}}),this.handleMessage(o,r)}))}}};function pt(s){return s.replace(/["<&]/g,e=>{switch(e){case'"':return"&quot;";case"<":return"&lt;";case"&":return"&amp;";default:return e}})}S();var $e=h(require("vscode"));async function N(){try{await $e.commands.executeCommand("workbench.view.extension.codexViewContainer"),await $e.commands.executeCommand(`${q.viewType}.focus`)}catch(s){p.error(`Failed to focus Codex view: ${s instanceof Error?s.message:String(s)}`)}}var lt=h(require("path")),fe=h(require("vscode"));async function ut(s){let e=fe.window.activeTextEditor;if(!e)return;let t=e.document.uri;if(t.scheme!=="file")return;let o=e.selection.start.line+1,r=e.selection.end.line+1;e.selection.end.character===0&&e.selection.end.line>e.selection.start.line&&r--;let n=t.fsPath,i=lt.basename(n),a=o!=null?`${i}:${o}`+(r!=null&&r!==o?`:${r}`:""):i;await N(),s.addContextFile({label:a,path:fe.workspace.asRelativePath(n),fsPath:n,startLine:o,endLine:r})}var mt=require("crypto"),qe=class s{constructor(e){this.mcpConnection=e;let t=this.mcpConnection.registerProvider(s.providerName,{onNotification:o=>this.handleNotification(o),onResult:o=>this.handleResult(o)});this.disposables.push(t)}static providerName="auth";disposables=[];pending=new Map;async getToken({refreshToken:e}){let t=(0,mt.randomUUID)(),o=new Promise((r,n)=>{this.pending.set(t,{resolve:r,reject:n})});return this.mcpConnection.sendRequest(s.providerName,t,"getAuthStatus",{includeToken:!0,refreshToken:e}),o}resolve(e,t){let o=this.pending.get(e);o&&(this.pending.delete(e),o.resolve(t))}reject(e,t){let o=this.pending.get(e);o&&(this.pending.delete(e),o.reject(t))}handleResult(e){if(typeof e.id!="string")return;if(e.error){this.reject(e.id,e.error);return}let t=e.result??null;this.resolve(e.id,t?.authToken??null)}handleNotification(e){e.method==="codex/event/auth_status_change"&&this.getToken({refreshToken:!1})}dispose(){for(let e of this.disposables)e.dispose();this.disposables.length=0,this.pending.clear()}};function ft(s){return new qe(s)}z();z();var es="http://localhost:8000/api",ts="https://chatgpt.com/backend-api";function os(){switch(k().get(nt)){case"localhost":return es;case"production":default:return ts}}function Ve(s){return s.startsWith("data:")||s.startsWith("http")?s:`${os()}/${s.replace(/^\//,"")}`}S();function ss(s){let e=s.split(/\r?\n/),t,o=[];for(let n of e)n.startsWith("event:")?t=n.slice(6).trim():n.startsWith("data:")&&o.push(n.slice(5).trim());if(o.length===0)return null;let r=o.join(`
`);try{return{event:t,data:JSON.parse(r)}}catch{return null}}function rs(s){let e=s.indexOf(`\r
\r
`),t=s.indexOf(`

`);return e===-1&&t===-1?[-1,0]:e===-1?[t,2]:t===-1?[e,4]:e<t?[e,4]:[t,2]}function ns(s,e){return{async next(){if(e.aborted)return{done:!0,value:void 0};let{value:t,done:o}=await s.read();return o||t==null?{done:!0,value:void 0}:{done:!1,value:t}},[Symbol.asyncIterator](){return this}}}async function*ht(s,e){let t=s.getReader(),o=new TextDecoder,r="",n=ns(t,e);try{for await(let i of n){r+=o.decode(i,{stream:!0});let a,c;for(;[a,c]=rs(r),a>=0;){let d=r.slice(0,a);r=r.slice(a+c);let u=ss(d);!u||u.event==="heartbeat"||(yield u)}}}finally{t.releaseLock()}}function gt(s){return!!s&&typeof s=="object"&&s.name==="AbortError"}function te(s){return new Promise(e=>setTimeout(e,s))}var ge="codex_vscode",yt="vscode://codex/",K=3,is=300,as=2e3,he=class{constructor(e,t,o){this.authProvider=e;this.extensionFetchHandler=t;this.userAgentProvider=o}abortSignals=new Map;streamControllers=new Map;shouldRetryStatus(e){return e===408||e===425||e===429||e>=500&&e<=599}backoffDelay(e){let t=Math.min(as,is*2**e),o=t*.2*(Math.random()-.5)*2;return Math.max(0,Math.floor(t+o))}buildHeaders(e,t,o){let r={...e??{}},n=a=>Object.keys(r).some(c=>c.toLowerCase()===a);if(o.attachAuth&&t&&!n("authorization")){r.Authorization=`Bearer ${t}`;try{let a=JSON.parse(Buffer.from(t.split(".")[1],"base64url").toString("utf8"))["https://api.openai.com/auth"]?.chatgpt_account_id;a&&(r["ChatGPT-Account-Id"]=a)}catch{}}o.method!=="GET"&&!n("content-type")&&(r["Content-Type"]="application/json"),n("originator")||(r.originator=ge);let i=this.userAgentProvider.getUserAgent();return i&&!n("user-agent")&&(r["User-Agent"]=i),r}shouldAttachAuth(e){let o=new URL(e).host.toLowerCase();return o==="localhost:8000"||o==="localhost"||o.endsWith(".openai.com")||o==="openai.com"||o==="chatgpt.com"||o.endsWith(".chatgpt.com")&&!o.startsWith("ab.")}async fetch(e){try{let t=new AbortController;if(this.abortSignals.set(e.requestId,t),t.signal.addEventListener("abort",()=>({type:"fetch-response",responseType:"error",error:"Request cancelled",requestId:e.requestId,status:499})),e.url.startsWith(yt)){let a=await this.extensionFetchHandler.handleVSCodeRequest(e.url.slice(yt.length),e.body?JSON.parse(e.body):void 0);return{type:"fetch-response",responseType:"success",requestId:e.requestId,status:200,headers:{},bodyJsonString:JSON.stringify(a)}}let o=Ve(e.url),r=await this.authProvider.getToken({refreshToken:!1}),n=this.shouldAttachAuth(o),i=async(a,c)=>{if(n&&!cs(c))return{type:"fetch-response",responseType:"error",requestId:e.requestId,status:401,error:`Cannot fetch ${e.url} without ChatGPT auth.`};let d=this.buildHeaders(e.headers,c,{method:e.method,attachAuth:n}),u=Object.keys(d).some(f=>f.toLowerCase()==="authorization");try{let f=e.body,l=Object.keys(d).find(E=>E.toLowerCase()==="x-codex-base64");if(l&&d[l]==="1"){if(e.body)try{f=Buffer.from(e.body,"base64")}catch{f=e.body}delete d[l]}let y=await fetch(o,{method:e.method,headers:d,body:f,signal:t.signal});if(y.status>=200&&y.status<300){let E=y.headers.get("content-type")||"",Z;if(E.includes("application/json")){let $=await y.json();Z=JSON.stringify($)}else{let $=await y.arrayBuffer(),j=Buffer.from($).toString("base64");Z=JSON.stringify({base64:j,contentType:E})}this.abortSignals.delete(e.requestId);let pe={};return y.headers.forEach(($,j)=>{j!=="authorization"&&(pe[j]=$)}),{type:"fetch-response",responseType:"success",requestId:e.requestId,status:y.status,headers:pe,bodyJsonString:Z}}if(y.status===401&&u&&a<K){let E=await this.authProvider.getToken({refreshToken:!0});if(E&&E!==c)return i(a+1,E)}if(this.shouldRetryStatus(y.status)&&a<K){let E=this.backoffDelay(a);return await te(E),i(a+1,c)}let P=y.headers.get("cf-ray");return y.status===404?p.info(`Error fetching ${e.url}: ${y.status} ${y.statusText} (${P})`):p.error(`Error fetching ${e.url}: ${y.status} ${y.statusText} (${P})`),{type:"fetch-response",responseType:"error",requestId:e.requestId,status:y.status,error:y.statusText}}catch(f){if(t.signal.aborted)return{type:"fetch-response",responseType:"error",error:"Request cancelled",requestId:e.requestId,status:499};if(a<K){let l=this.backoffDelay(a);return await te(l),i(a+1,c)}return p.error(`Error fetching ${e.url}: ${String(f)}`),{type:"fetch-response",responseType:"error",requestId:e.requestId,status:500,error:f instanceof Error?f.message:"Unknown error"}}};return i(0,r)}catch(t){return p.error(`Error fetching ${e.url}: ${t}`),{type:"fetch-response",responseType:"error",requestId:e.requestId,status:500,error:t instanceof Error?t.message:"Unknown error"}}finally{this.abortSignals.delete(e.requestId)}}async stream(e,t){let o=new AbortController;this.streamControllers.set(e.requestId,o);let r=Ve(e.url),n=await this.authProvider.getToken({refreshToken:!1}),i=this.shouldAttachAuth(r),a=async(c,d)=>{let u=this.buildHeaders(e.headers,d,{method:e.method,attachAuth:i}),f=Object.keys(u).some(l=>l.toLowerCase()==="authorization");try{let l=await fetch(r,{method:e.method,headers:u,body:e.body,signal:o.signal});if(l.status===200&&l.body!=null){for await(let g of ht(l.body,o.signal))t({type:"fetch-stream-event",requestId:e.requestId,event:g.event,data:g.data});t({type:"fetch-stream-complete",requestId:e.requestId});return}if(l.status===401&&f&&c<K){let g=await this.authProvider.getToken({refreshToken:!0});if(g&&g!==d){await a(c+1,g);return}}if(this.shouldRetryStatus(l.status)&&c<K){let g=this.backoffDelay(c);await te(g),await a(c+1,d);return}t({type:"fetch-stream-error",requestId:e.requestId,error:`${l.status} ${l.statusText}`})}catch(l){if(o.signal.aborted||gt(l)){t({type:"fetch-stream-complete",requestId:e.requestId});return}if(c<K){let g=this.backoffDelay(c);await te(g),await a(c+1,d);return}t({type:"fetch-stream-error",requestId:e.requestId,error:l instanceof Error?l.message:"Unknown error"})}};try{await a(0,n)}finally{this.streamControllers.delete(e.requestId)}}cancel(e){let t=this.abortSignals.get(e);t&&(t.abort(),this.abortSignals.delete(e))}cancelStream(e){let t=this.streamControllers.get(e);t&&(t.abort(),this.streamControllers.delete(e))}};function cs(s){return s?/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+$/.test(s):!1}le();function oe(){if(!0){let{platform:s,arch:e}=process,t,o;switch(s){case"win32":t="windows";break;case"darwin":t="macos";break;case"aix":case"android":case"freebsd":case"haiku":case"linux":case"openbsd":case"sunos":case"cygwin":case"netbsd":t="linux";break}switch(e){case"x64":o="x86_64";break;case"arm64":o="aarch64";break;case"arm":case"ia32":case"loong64":case"mips":case"mipsel":case"ppc64":case"riscv64":case"s390x":throw new Error(`unrecognized architecture: ${e}`)}return`bin/${`${t}-${o}`}`}return"bin"}S();var vt=require("child_process");var V={CLI_EXECUTABLE:"cliExecutable",COMMENT_CODELENS_ENABLED:"commentCodeLensEnabled",OPEN_ON_STARTUP:"openOnStartup"};var se={HAS_PROBABLY_SEEN_2025_08_27_NUX:"hasProbablySeen2025-08-27-nux",NUX_2025_09_15:"viewed2025-09-15-nux",NUX_2025_09_15_FULL_CHATGPT_AUTH_VIEWED:"viewed2025-09-15-full-chatgpt-auth-nux",NUX_2025_09_15_APIKEY_AUTH_VIEWED:"viewed2025-09-15-apikey-auth-nux",WINDOWS_WSL_REMINDER_DISMISSED_AT:"windows-wsl-reminder-dismissed-date"};var wt=h(require("readline")),O=h(require("vscode")),bt="1";async function xt(s,e){let t=ps(s),o=process.platform==="win32"?";":":",r=process.env.PATH+o+O.Uri.joinPath(s,oe()).fsPath,n=(0,vt.spawn)(t,["app-server"],{stdio:["pipe","pipe","pipe"],env:{...process.env,PATH:r,RUST_LOG:"warn",CODEX_INTERNAL_ORIGINATOR_OVERRIDE:ge}});if(n.pid==null)throw new Error(`Failed to spawn codex mcp process at ${t}`);let i=new Ge(n,e);{let a={id:bt,method:"initialize",params:{clientInfo:{name:us(),title:"Codex Extension",version:We()}}};n.stdin.destroyed||n.stdin.write(JSON.stringify(a)+`
`)}return await i.whenInitialized,i}var Ge=class{constructor(e,t){this.proc=e;this.userAgentProvider=t;e.on("error",o=>{p.error(`codex mcp process error: ${o}`)}),e.on("exit",(o,r)=>{o!==0?p.error(`codex mcp process exited with code ${o} and signal ${r}`):p.info("codex mcp process exited successfully.")}),e.stderr&&e.stderr.on("data",o=>{let r=ds(o.toString().trim());if(r){let{level:n,message:i}=ls(r),a="CLI:";switch(n){case"trace":case"debug":case"info":p.info(`${a} ${i}`);break;case"warn":p.warn(`${a} ${i}`);break;case"error":p.error(`${a} ${i}`);break}}}),this.whenInitialized=new Promise((o,r)=>{this.resolveInit=o,this.rejectInit=r}),this.rl=wt.createInterface({input:e.stdout}),this.rl.on("line",o=>{let r=o.trim(),n;try{n=JSON.parse(r)}catch(i){p.error(`unable to parse stdout from codex mcp: ${i}`);return}if(!this.initialized){if("id"in n&&("result"in n||"error"in n)&&n.id===bt){if("error"in n&&n.error){let i=new Error(`Failed to initialize local agent: ${JSON.stringify(n.error)}`);this.rejectInit?.(i)}else{let i=n.result;this.userAgentProvider.setUserAgent(i.userAgent??ge),this.initialized=!0,this.resolveInit?.()}return}p.warn(`Dropping MCP message received before initialization: ${r}`);return}this.routeIncomingMessage(n)})}rl;providers=new Map;initialized=!1;whenInitialized;resolveInit;rejectInit;registerProvider(e,t){if(this.providers.has(e))throw new Error(`Provider already registered: ${e}`);return this.providers.set(e,t),new O.Disposable(()=>{this.providers.delete(e)})}sendRequest(e,t,o,r){let i={id:`${e}:${t}`,method:o,params:r};this.sendMessage(i)}sendNotification(e,t){let o={method:e,params:t};this.sendMessage(o)}sendResponse(e,t){let o={id:e,result:t};this.sendMessage(o)}sendMessage(e){let{stdin:t}=this.proc;t.destroyed||t.write(JSON.stringify(e)+`
`)}routeIncomingMessage(e){if(this.isMcpResponseMessage(e)){let t=e.id;if(typeof t=="string"&&t.includes(":")){let[o,...r]=t.split(":"),n=r.join(":"),i=this.providers.get(o);if(i?.onResult){let a={...e,id:n};i.onResult(a)}return}p.warn(`Received MCP response with id=${JSON.stringify(t)} but no provider namespace`);return}if(this.isMcpRequestMessage(e)){for(let[,t]of this.providers)t.onRequest?.(e);return}if(typeof e.method=="string"){let{method:t,params:o}=e;for(let[,r]of this.providers)r.onNotification?.({method:t,params:o});return}p.error(`Received unknown MCP message: ${JSON.stringify(e)}`)}isMcpResponseMessage(e){return"id"in e&&("result"in e||"error"in e)}isMcpRequestMessage(e){return typeof e.method=="string"&&"id"in e&&e.id!=null}dispose(){this.rl.close(),this.proc.kill()}};function ps(s){let e=k().get(V.CLI_EXECUTABLE);if(e&&e.trim().length>0)return e;{let t=process.platform==="win32"?"codex.exe":"codex",o=oe();return O.Uri.joinPath(s,`${o}/${t}`).fsPath}}function ds(s){return s.replace(/\x1b\[[0-9;]*m/g,"")}function ls(s){let e=s.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d+Z\s+(\w+)\s+(.+)$/);if(e){let t=e[1].toLowerCase();return t==="trace"||t==="debug"||t==="info"||t==="warn"||t==="error"?{level:t,message:e[2]}:{level:"error",message:e[2]}}return{level:"error",message:s}}function us(){let s=O.env.appName??"",e=s.toLowerCase();return e.includes("cursor")?"Cursor":e.includes("windsurf")?"Windsurf":e.includes("visual studio code")||e==="code"||e.startsWith("code ")||e.endsWith(" code")||e.includes("vscode")?"VS Code":s||"VS Code"}function We(){let e=O.extensions.getExtension("openai.chatgpt")?.packageJSON?.version;return typeof e=="string"&&e.trim().length>0?e:"0.0.0"}z();var ye=class{constructor(e,t=[],o=[],r){this.child=e;this.stdoutChunks=t;this.stderrChunks=o;this.promise=r.then(({code:n,signal:i})=>({type:"resolve",code:n,signal:i}),n=>({type:"reject",error:n}))}result=null;promise;check(){return this.wait().then(({stdout:e,stderr:t,code:o,signal:r})=>{if(o===0)return{stdout:e,stderr:t};throw new Error(`process exited with code ${o}, signal ${r}`)})}wait(){return this.promise.then(e=>{switch(e.type){case"resolve":{let{code:t,signal:o}=e;return{stdout:Buffer.concat(this.stdoutChunks).toString("utf8"),stderr:Buffer.concat(this.stderrChunks).toString("utf8"),code:t,signal:o}}case"reject":throw e.error}})}getStdout(){return Buffer.concat(this.stdoutChunks)}getStderr(){return Buffer.concat(this.stderrChunks)}getExitCode(){return this.result?.type==="resolve"?this.result.code:null}isDone(){return this.result!=null}kill(){this.child.kill()}};var Rt=require("child_process");function T({args:s,cwd:e}){let t=(0,Rt.spawn)(s[0],s.slice(1),{cwd:e,env:{...process.env},stdio:["ignore","pipe","pipe"]});if(!t.pid)throw new Error(`failed to start process from ${e}: \`${s.join(" ")}\``);let o=[],r=[],n=new Promise((i,a)=>{t.stdout?.on("data",c=>{o.push(c)}),t.stderr?.on("data",c=>{r.push(c)}),t.on("exit",(c,d)=>{i({code:c,signal:d})}),t.on("error",c=>{a(c)})});return new ye(t,o,r,n)}S();async function ve(s){try{let e=T({args:["git","rev-parse","--show-toplevel"],cwd:s}),{stdout:t,code:o}=await e.wait();if(o===0)return t.trim()}catch{p.info(`getGitRoot: ${s} is not a git repository`)}return null}S();function Ct(s,e){let t=new Set,o=new Set,r=new Set,n=null,i=[s,e].filter(Boolean).join(`
`),a=(A,v)=>{let m=(v??"").trim();if(!m)return;let R=m.charAt(0),Vo=m.charAt(m.length-1),Fe=m;(R==="'"||R==='"')&&Vo===R&&m.length>=2&&(Fe=m.slice(1,-1)),Fe&&A.add(Fe)},c=(A,v)=>{for(let m of v)if(A[m])return A[m]},d=/^(?:Applied patch(?: to)?\s+(?:(["'])(?<qpath>.+?)\1|(?<path>.+?))\s+cleanly\.?)$/i,u=/^(?:Applied patch(?: to)?\s+(?:(["'])(?<qpath>.+?)\1|(?<path>.+?))\s+with conflicts\.?)$/i,f=/^(?:Applying patch\s+(?:(["'])(?<qpath>.+?)\1|(?<path>.+?))\s+with\s+\d+\s+rejects?\.{0,3})$/i,l=/^(?:Checking patch\s+(?:(["'])(?<qpath>.+?)\1|(?<path>.+?))\.\.\.)$/i,g=/^(?:Performing three-way merge|Falling back to three-way merge)\.\.\.$/i,y=/^Failed to perform three-way merge\.\.\.$/i,P=/^Falling back to direct application\.\.\.$/i,E=/^U\s+(?<path>.+)$/,Z=/^error:\s+patch failed:\s+(?<path>.+?)(?::\d+)?(?:\s|$)/i,pe=/^error:\s+(?<path>.+?):\s+patch does not apply$/i,$=/^(?:error: )?repository lacks the necessary blob to (?:perform|fall back on) 3-?way merge\.?$/i,j=/^error:\s+(?<path>.+?):\s+does not match index\b/i,Mo=/^error:\s+(?<path>.+?):\s+does not exist in index\b/i,No=/^error:\s+(?<path>.+?)\s+already exists in (?:the )?working directory\b/i,Do=/^error:\s+patch failed:\s+(?<path>.+?)\s+File exists/i,Oo=/^error:\s+path\s+(?<path>.+?)\s+has been renamed\/deleted/i,_o=/^error:\s+cannot apply binary patch to\s+['"]?(?<path>.+?)['"]?\s+without full index line$/i,Lo=/^error:\s+binary patch does not apply to\s+['"]?(?<path>.+?)['"]?$/i,Fo=/^error:\s+binary patch to\s+['"]?(?<path>.+?)['"]?\s+creates incorrect result\b/i,Uo=/^error:\s+cannot read the current contents of\s+['"]?(?<path>.+?)['"]?$/i,$o=/^Skipped patch\s+['"]?(?<path>.+?)['"]\.$/i,qo=/^warning:\s*Cannot merge binary files:\s+(?<path>.+?)\s+\(ours\s+vs\.\s+theirs\)/i;for(let A of i.split(/\r?\n/)){let v=A.trim();if(!v)continue;let m;if(m=v.match(d)){let R=c(m.groups??{},["qpath","path"]);a(t,R),n=R??n,r.delete(R??""),o.delete(R??"");continue}if(m=v.match(u)){let R=c(m.groups??{},["qpath","path"]);a(r,R),n=R??n,t.delete(R??""),o.delete(R??"");continue}if(m=v.match(f)){let R=c(m.groups??{},["qpath","path"]);a(r,R),n=R??n,t.delete(R??""),o.delete(R??"");continue}if(m=v.match(E)){a(r,m.groups?.path),n=m.groups?.path??n,t.delete(m.groups?.path??""),o.delete(m.groups?.path??"");continue}if(m=v.match(l)){n=c(m.groups??{},["qpath","path"])??n;continue}if((m=v.match(Z))||(m=v.match(pe))){a(o,m.groups?.path),n=m.groups?.path??n;continue}if(!(g.test(v)||P.test(v))){if(y.test(v)){n&&(a(o,n),t.delete(n),r.delete(n));continue}if($.test(v)){n&&(a(o,n),t.delete(n),r.delete(n));continue}if((m=v.match(j))||(m=v.match(Mo))||(m=v.match(No))||(m=v.match(Do))||(m=v.match(Oo))||(m=v.match(_o))||(m=v.match(Lo))||(m=v.match(Fo))||(m=v.match(Uo))||(m=v.match($o))){a(o,m.groups?.path),n=m.groups?.path??n,t.delete(m.groups?.path??""),r.delete(m.groups?.path??"");continue}if(m=v.match(qo)){a(r,m.groups?.path),n=m.groups?.path??n,t.delete(m.groups?.path??""),o.delete(m.groups?.path??"");continue}}}for(let A of r)t.delete(A),o.delete(A);for(let A of t)o.delete(A);return{appliedPaths:Array.from(t).sort(),skippedPaths:Array.from(o).sort(),conflictedPaths:Array.from(r).sort()}}var _=h(require("fs/promises")),St=h(require("os")),we=h(require("path"));async function Pt({cwd:s,diff:e,revert:t}){let o=await ve(s);if(!o)throw new Error(`${s} is not a git repository`);let r=await _.mkdtemp(we.join(St.tmpdir(),"codex-apply-")),n=we.join(r,"patch.diff");await _.writeFile(n,e,"utf8"),t&&await ms(o,e);let i=["git","apply",t?"-R":null,"--3way",n].filter(Boolean),a=T({args:i,cwd:o}),{code:c,stdout:d,stderr:u}=await a.wait();p.info(`applyPatch revert: ${t}, code: ${c}, stdout: ${d}, stderr: ${u}`);let{appliedPaths:f,skippedPaths:l,conflictedPaths:g}=Ct(d,u);return await _.rm(r,{recursive:!0,force:!0}),{status:c===0?"success":c===1?"partial-success":"error",appliedPaths:f,skippedPaths:l,conflictedPaths:g}}async function ms(s,e){let t=fs(e),o=(await Promise.all(t.map(async r=>{try{return await _.access(we.join(s,r)),r}catch{return p.info(`Skipping staging ${r} because it does not exist in the working tree`),null}}))).filter(r=>!!r);if(o.length>0){let r=["git","add","--",...o],i=await T({args:r,cwd:s}).wait();p.info(`Staged ${o.length} files: ${i.code}`)}}function fs(s){let e=new Set,t=/^diff --git a\/(.*?) b\/(.*)$/gm,o;for(;(o=t.exec(s))!=null;){let[r,n,i]=o;n&&n!=="/dev/null"&&e.add(n),i&&i!=="/dev/null"&&e.add(i)}return Array.from(e)}z();S();S();var Et=h(require("fs")),J=h(require("path")),G=h(require("vscode"));async function kt(s,e=10){let t=G.workspace.workspaceFolders??[];if(s.trim().length===0||t.length===0)return[];let o=[],r=`**/*${hs(s)}*`,n=gs();for(let i of t){if(o.length>=e)break;try{let c=T({args:[n??"rg","--files","--iglob",r],cwd:i.uri.fsPath}),{stdout:d,code:u}=await c.wait();if(u!==0)return[];let f=d.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);for(let l of f){if(o.length>=e)break;let g=J.isAbsolute(l)?l:J.join(i.uri.fsPath,l),y=J.basename(g).replace(/\\/g,"/"),P=G.workspace.asRelativePath(g).replace(/\\/g,"/");o.push({label:y,path:P,fsPath:g})}}catch(a){p.warn(`rg search failed in ${i.uri.fsPath}: ${String(a)}`)}}return o}function hs(s){let e=["*","?","[","]","{","}","!","\\"],t="";for(let o of s)t+=e.includes(o)?"\\"+o:o;return t}function gs(){try{let s=G.extensions.getExtension("openai.chatgpt");if(!s)return null;let e=process.platform==="win32"?"rg.exe":"rg",t=oe(),o=G.Uri.joinPath(s.extensionUri,t,e).fsPath;return Et.existsSync(o)?o:null}catch{return null}}var It=require("child_process"),xe=h(require("fs")),Re=h(require("fs/promises")),At=h(require("os")),X=h(require("path")),ys=200*1024*1024;async function Mt(s,e){let t=vs(s),o=X.basename(t)||"repo";await Cs(t,ys);let r=await be(t,["rev-parse","HEAD"]),n=await be(t,["rev-parse","--abbrev-ref","HEAD"]),i=n&&n!=="HEAD"?n:null,a=await be(t,["remote","-v"]),c=Rs(a),d=`${o}-snapshot-${Date.now()}.tar.gz`,u=X.join(At.tmpdir(),d);if(e)await bs(t,u,e);else{let l=await ws(t);await xs(t,u,l)}let f=await Re.stat(u);return{tarballPath:u,tarballFilename:d,tarballSize:f.size,repoName:o,branch:i,snapshotBranch:e??i??r,commitSha:r,remotes:c,contentType:"application/gzip"}}async function Nt({tarballPath:s,uploadUrl:e,contentLength:t,contentType:o}){let r=xe.createReadStream(s);try{let n=await fetch(e,{method:"PUT",headers:{"Content-Type":o,"Content-Length":t.toString(),"x-ms-blob-type":"BlockBlob"},body:r,duplex:"half"});if(!n.ok){let i=await n.text().catch(()=>"");throw new Error(`Snapshot upload failed with status ${n.status} ${n.statusText}${i?`: ${i}`:""}`)}}finally{r.destroy(),await Re.unlink(s).catch(()=>{})}}function vs(s){let e=X.resolve(s);if(!xe.existsSync(e))throw new Error(`Git root does not exist: ${e}`);return e}async function He(s,e){let t=T({args:["git",...e],cwd:s}),{stdout:o,stderr:r,code:n}=await t.wait();return{stdout:o,stderr:r,code:n}}async function be(s,e){let{stdout:t,stderr:o,code:r}=await He(s,e);if(r!==0){let n=o.trim()||t.trim();throw new Error(`git ${e.join(" ")} failed${n?`: ${n}`:""}`)}return t.trim()}async function ws(s){let{stdout:e,stderr:t,code:o}=await He(s,["ls-files","--cached","--others","--exclude-standard","-z"]);if(o!==0){let r=t.trim();throw new Error(`git ls-files failed${r?`: ${r}`:""}`)}return e?e.split("\0").map(r=>r.trim()).filter(r=>r.length>0):[]}async function bs(s,e,t){await He(s,["archive","--format=tar.gz","-o",e,t])}async function xs(s,e,t){await new Promise((o,r)=>{let i=(0,It.spawn)("tar",["--null","-czf",e,"-C",s,"--files-from","-"],{stdio:["pipe","ignore","pipe"]}),a="";if(i.stderr?.setEncoding("utf8"),i.stderr?.on("data",c=>{a+=c}),i.on("error",c=>r(c)),i.on("close",c=>{c===0?o():r(new Error(`tar exited with code ${c}${a?`: ${a.trim()}`:""}`))}),i.stdin){if(t.length>0){let c=`${t.join("\0")}\0`;i.stdin.write(c,"utf8",d=>{d&&r(d)})}i.stdin.end()}})}function Rs(s){let e={};for(let t of s.split(/\r?\n/)){let o=t.trim();if(!o)continue;let r=o.split(/\s+/);if(r.length<3)continue;let[n,i,a]=r;a==="(push)"&&e[n]==null&&(e[n]=i)}return e}async function Cs(s,e){let t=await be(s,["count-objects","-v"]),o=Ss(t),n=((o.get("size")??0)+(o.get("size-pack")??0))*1024;if(n>e)throw new Error(`Repository is too large (${Tt(n)}). Maximum allowed size is ${Tt(e)}.`)}function Ss(s){let e=new Map;for(let t of s.split(/\r?\n/)){let o=t.trim();if(!o)continue;let[r,n]=o.split(":");if(!r||n==null)continue;let i=Number.parseInt(n.trim(),10);Number.isFinite(i)&&e.set(r,i)}return e}function Tt(s){if(s<1024)return`${s} B`;let e=["KB","MB","GB","TB"],t=s/1024,o=0;for(;t>=1024&&o<e.length-1;)t/=1024,o+=1;return`${t.toFixed(1)} ${e[o]}`}var Dt=require("node:child_process"),re=h(require("os")),Ot=h(require("path"));var b=h(require("vscode")),Ps=[{command:"wsl.exe",args:["--status"]}];function Es(s){if(s!=="win32")return!1;for(let{command:e,args:t}of Ps)try{let o=(0,Dt.spawnSync)(e,t,{windowsHide:!0,stdio:"ignore"});if(o.error){if(o.error?.code==="ENOENT")return!1;continue}if(o.status===0)return!0}catch(o){if(o?.code==="ENOENT")return!1}return!1}var Ce=class{constructor(e,t,o){this.authProvider=e;this.ideContextConnection=t;this.globalState=o}handlers={"workspace-roots":async()=>({roots:b.workspace.workspaceFolders?.map(e=>e.uri.fsPath)??[]}),"has-custom-cli-executable":async()=>({hasCustomCliExecutable:(k().get(V.CLI_EXECUTABLE)??"").trim().length>0}),"account-info":async()=>{let e=await this.authProvider.getToken({refreshToken:!1});if(!e)return{accountId:null,userId:null,plan:null,email:null};try{let t=JSON.parse(Buffer.from(e.split(".")[1],"base64url").toString("utf8")),o=t["https://api.openai.com/auth"]??{},r=t["https://api.openai.com/profile"]??{},n=o?.chatgpt_account_id??null,i=o?.chatgpt_user_id??null,a=o?.chatgpt_plan_type??null,c=r.email??null;if(n&&i&&a)return{accountId:n,userId:i,plan:a,email:c}}catch{p.error("Unable to extract account id and plan from auth token.")}return{accountId:null,userId:null,plan:null,email:null}},"extension-info":async()=>({version:We()}),"os-info":async()=>{let e=re.platform();return{platform:e,hasWsl:Es(e)}},"openai-api-key":async()=>({value:process.env.OPENAI_API_KEY??null}),"find-files":async({query:e})=>({files:await kt(e,10)??[]}),"ide-context":async()=>({ideContext:this.ideContextConnection.getIdeContext()}),"apply-patch":async e=>Pt(e),"open-file":async({path:e,line:t,column:o})=>{let r=typeof t=="number"?t:void 0,n=typeof o=="number"?o:1,i=e.replace(/^([ab])[\\/]/,""),a=b.workspace.workspaceFolders??[],c=async f=>{try{let l=await b.workspace.openTextDocument(f),g=r!=null?new b.Range(new b.Position(Math.max(0,r-1),Math.max(0,n-1)),new b.Position(Math.max(0,r-1),Math.max(0,n-1))):void 0;return await b.window.showTextDocument(l,g?{preview:!1,selection:g}:void 0),!0}catch{return!1}};if(Ot.isAbsolute(i)){let f=await c(b.Uri.file(i));return f||p.error(`Failed to open absolute path: ${i}`),{success:f}}let d=i.split(/[\\/]+/).filter(Boolean),u=!1;for(let f of a){if(u)break;let l=b.Uri.joinPath(f.uri,...d);if(await c(l)){u=!0;break}let g=d.indexOf(f.name);if(g!==-1){let y=b.Uri.joinPath(f.uri,...d.slice(g+1));if(await c(y)){u=!0;break}}}if(!u&&i.length>0)try{let f=`**/${i.replace(/\\/g,"/")}`,l=await b.workspace.findFiles(f,void 0,1);l.length>0&&(u=await c(l[0]))}catch{}if(!u){let f=a.map(l=>l.uri.fsPath).join(", ");p.error(`Failed to resolve and open file from path "${e}" (normalized: "${i}") in workspaces: [${f}]`)}return{success:u}},"git-origins":async()=>{let e=b.workspace.workspaceFolders??[],t=[],o=new Set,r=re.homedir();return await Promise.all(e.map(async n=>{let i=n.uri.fsPath;try{let a=T({args:["git","rev-parse","--show-toplevel"],cwd:n.uri.fsPath}),{stdout:c,code:d}=await a.wait();d===0&&(i=c.trim())}catch{}try{let a=T({args:["git","config","--get","remote.origin.url"],cwd:i}),{stdout:c,code:d}=await a.wait(),u=d===0?c.trim():null;o.has(i)||(t.push({root:i,originUrl:u}),o.add(i))}catch{o.has(i)||(t.push({root:i,originUrl:null}),o.add(i))}})),{origins:t,homeDir:r}},"git-roots":async()=>{let e=b.workspace.workspaceFolders??[],t=re.homedir();return{roots:(await Promise.all(e.map(r=>ve(r.uri.fsPath)))).filter(r=>r!=null),homeDir:t}},"git-current-branch":async({gitRoot:e})=>{let t=b.workspace.workspaceFolders??[],o=e??t[0]?.uri.fsPath;if(!o)return{branch:null};try{let r=T({args:["git","rev-parse","--abbrev-ref","HEAD"],cwd:o}),{stdout:n,code:i}=await r.wait();if(i===0){let a=n.trim();return{branch:a&&a!=="HEAD"?a:null}}}catch{}return{branch:null}},"prepare-worktree-snapshot":async({gitRoot:e,snapshotBranch:t})=>Mt(e,t),"upload-worktree-snapshot":async({tarballPath:e,uploadUrl:t,contentLength:o,contentType:r})=>{try{await Nt({tarballPath:e,uploadUrl:t,contentLength:o,contentType:r})}catch(n){return p.error(`Failed to upload worktree snapshot: ${n}`),{success:!1}}return{success:!0}},"get-configuration":async({key:e})=>({value:k().get(e)}),"set-configuration":async({key:e,value:t})=>(await k().update(e,t),{success:!0}),"get-global-state":async({key:e})=>({value:await this.globalState.get(e)}),"set-global-state":async({key:e,value:t})=>{try{return await this.globalState.update(e,t),{success:!0}}catch{return{success:!1}}},"set-vs-context":async({key:e,value:t})=>(await b.commands.executeCommand("setContext",e,t),{success:!0})};handleVSCodeRequest(e,t){return this.handlers[e](t)}};S();var _t=h(require("fs/promises")),Lt=h(require("os")),Be=h(require("path"));var Se=class{constructor(e){this.context=e}async get(e){let t=this.context.globalState.get(e);if(e===se.HAS_PROBABLY_SEEN_2025_08_27_NUX&&t==null){let o=ks(),r=Be.join(o,"sessions"),n;try{n=(await _t.stat(r)).isDirectory(),n&&this.update(se.HAS_PROBABLY_SEEN_2025_08_27_NUX,!0)}catch{n=!1}return n}return t}async update(e,t){await this.context.globalState.update(e,t)}async dumpNuxState(){let e=Object.entries(se);for(let[t,o]of e){let r=this.context.globalState.get(o);p.info(`Global state ${t} (${o}): ${r}`)}}async resetNuxState(){p.info("Resetting NUX state"),await Promise.all(Object.values(se).map(e=>this.context.globalState.update(e,void 0)))}};function ks(){return process.env.CODEX_HOME??Be.join(Lt.homedir(),".codex")}var D=h(require("vscode"));function Ts(s){return s.path.split("/").pop()??""}function je(){return D.window.tabGroups.all.flatMap(s=>s.tabs.filter(e=>e.input?.uri?.scheme==="file").map(e=>({label:e.label,path:D.workspace.asRelativePath(e.input?.uri?.fsPath),fsPath:e.input?.uri?.fsPath})))}function ze(s){return{label:Ts(s.document.uri),path:D.workspace.asRelativePath(s.document.uri.fsPath),fsPath:s.document.uri.fsPath,selection:s.selection,activeSelectionContent:s.document.getText(s.selection),selections:s.selections.map(e=>({start:e.start,end:e.end}))}}var Pe=class{onIdeContextChangeEmitter=new D.EventEmitter;listeners=[];ideContext={activeFile:void 0,openTabs:[]};constructor(){this.listeners.push(D.window.onDidChangeActiveTextEditor(e=>this.onChangeActiveTextEditor(e))),this.listeners.push(D.window.onDidChangeTextEditorSelection(e=>{this.onChangeTextEditorSelection(e)})),this.initIdeContext()}get onIdeContextChange(){return this.onIdeContextChangeEmitter.event}getIdeContext(){return this.ideContext}initIdeContext(){let e=D.window.activeTextEditor;this.ideContext={activeFile:e?ze(e):void 0,openTabs:je()},this.onIdeContextChangeEmitter.fire(this.ideContext)}onChangeActiveTextEditor(e){this.ideContext={...this.ideContext,activeFile:e?ze(e):void 0,openTabs:je()},this.onIdeContextChangeEmitter.fire(this.ideContext)}onChangeTextEditorSelection(e){e.textEditor.document.uri.scheme==="file"&&(this.ideContext={...this.ideContext,activeFile:ze(e.textEditor),openTabs:je()},this.onIdeContextChangeEmitter.fire(this.ideContext))}dispose(){this.listeners.forEach(e=>e.dispose())}};S();var Ke=h(require("vscode")),Ee=class{shellIntegrationSubscription;pendingTerminals=new Map;constructor(){this.shellIntegrationSubscription=Ke.window.onDidChangeTerminalShellIntegration(e=>{let{terminal:t}=e,o=this.pendingTerminals.get(t);o&&(o(t),this.pendingTerminals.delete(t))})}createTerminal(e){let t=Ke.window.createTerminal(e);return new Promise(o=>{this.pendingTerminals.set(t,o)})}dispose(){this.shellIntegrationSubscription.dispose()}};function Ut(s){let e=[],t=s.length,o=0;function r(a,c){let d=s[a],u=c;for(;u<t&&s[u]===d;)u++;let f=ke(s,u),l=Ft(s,f,"TODO",!0),g=f;for(;g<t&&s[g]!==`
`&&s[g]!=="\r";)g++;if(l!==-1){let y=s.slice(l,g);e.push({body:y.trimEnd(),index:a})}return g}let n=null,i=!1;for(;o<t;){let a=s[o];if(n){i?i=!1:a==="\\"?i=!0:a===n&&(n=null),o++;continue}else if(a==='"'||a==="'"||a==="`"){n=a,o++;continue}if(a==="/"&&o+1<t){let c=s[o+1];if(c==="/"){o=r(o,o+2);continue}if(c==="*"){let d=o,u=o+2,f=s.indexOf("*/",u),l=f===-1?t:f+2,g=s.slice(u,f===-1?t:f);g=g.replace(/^(?:[ \t]*\*?[ \t]*(?:\r?\n|$))+/,"");let y=ke(g,0);g[y]==="*"&&(y=ke(g,y+1));let P=Ft(g,y,"TODO",!0);if(P!==-1){let E=g.slice(P);e.push({body:E.replace(/\s+$/,""),index:d})}o=l;continue}}else if(a==="#"){o=r(o,o+1);continue}else if(a==="-"&&o+1<t&&s[o+1]==="-"){o=r(o,o+2);continue}o++}return e}function Is(s){return s>=48&&s<=57||s>=65&&s<=90||s>=97&&s<=122||s===95}function ke(s,e){let t=e;for(;t<s.length;){let o=s.charCodeAt(t);if(o!==32&&o!==9)break;t++}return t}function Ft(s,e,t,o=!0){let r=s.slice(e,e+t.length),n=o?t.toUpperCase():t;if((o?r.toUpperCase():r)!==n)return-1;let i=s.charCodeAt(e+t.length);if(Is(i))return-1;let a=e+t.length;return(s[a]===":"||s[a]==="-")&&a++,a=ke(s,a),a}var Ie=h(require("vscode")),Te=class{provideCodeLenses(e,t){let o=e.getText(),r=[];for(let{index:n,body:i}of Ut(o)){if(t?.isCancellationRequested)break;let a=e.positionAt(n),c=new Ie.Range(a,a);r.push(new Ie.CodeLens(c,{title:"Implement with Codex",command:"chatgpt.implementTodo",arguments:[{fileName:encodeURIComponent(e.uri.fsPath),line:a.line+1,comment:i}]}))}return r}};S();var Ae=class{constructor(e){this.codexWebviewProvider=e}async handleUri(e){p.info({event:"handleUri",path:e.path});try{await N();let t=e.path||"/";this.codexWebviewProvider.navigateToRoute(t)}catch(t){p.error(`Failed to handle URI ${e.toString()}: ${t instanceof Error?t.message:String(t)}`)}}};var Me=class{userAgent=null;getUserAgent(){return this.userAgent}setUserAgent(e){this.userAgent=e}};var M=h(require("vscode"));async function qs(s){let{subscriptions:e}=s;e.push(p),p.info("Activating Codex extension");let t=new Ee;e.push(t);let o=new Me,r=await xt(s.extensionUri,o);e.push(r);let n=ft(r),i=new Se(s),a=new Pe;e.push(a);let c=new Ce(n,a,i),d=new he(n,c,o),u=new q(s.extensionUri,r,d,a);e.push(u);let f=new Ae(u);if(e.push(M.window.registerUriHandler(f)),e.push(M.window.registerWebviewViewProvider(q.viewType,u,{webviewOptions:{retainContextWhenHidden:!0}})),e.push(M.commands.registerCommand("chatgpt.openSidebar",N)),e.push(M.commands.registerCommand("chatgpt.addToChat",async()=>ut(u))),e.push(M.commands.registerCommand("chatgpt.newChat",async()=>{await N(),u.triggerNewChatViaWebview()})),k().get(V.COMMENT_CODELENS_ENABLED,!0)){let y=new Te,P=[{scheme:"file"},{scheme:"untitled"}];e.push(M.languages.registerCodeLensProvider(P,y))}k().get(V.OPEN_ON_STARTUP,!1)&&N(),e.push(M.commands.registerCommand("chatgpt.dumpNuxState",()=>{i.dumpNuxState()}),M.commands.registerCommand("chatgpt.resetNuxState",()=>{i.resetNuxState()})),process.platform==="darwin"&&(async()=>{try{let y=await Promise.resolve().then(()=>(Ao(),Io));typeof y.activate=="function"&&(y.activate(s),p.info("Work with apps desktop bridge initialized"))}catch(y){p.warn("Desktop bridge init failed: "+(y instanceof Error?y.message:String(y)))}})()}0&&(module.exports={activate});
